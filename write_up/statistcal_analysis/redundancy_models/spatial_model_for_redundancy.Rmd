---
title: "Spatial model for redundancy"
author: "Erick Calderón-Morales"
date: "March 28, 2019"
output: 
  html_document:
    code_folding: hide
    fig_height: 8
    fig_width: 10
    keep_md: yes
    toc: yes
    toc_depth: 2
    toc_float: yes
---

```{r message=FALSE, warning=FALSE}
#Paquetes
library(kableExtra)
library(lattice)
library(tidyverse)
library(PerformanceAnalytics)
library(janitor)
source("C:/tesis_catie/Calderon_CATIE/scripts/functions/HighstatLibV10.R")
library(ggbiplot)
library(GGally)
library(INLA)
```



#Objetivo 
Realizar un modelo linear multiple con dependencia espacial para los datos de Redundancia funcional efecto
Ref: Capitulo 12 Zuur et al.


```{r}
#Load data
dredun_eff <- read.csv("C:/tesis_catie/Calderon_CATIE/data/resultados_csv/data_indices_eff_redundancy.csv", header=T)
dredun_eff <- clean_names(dredun_eff) %>% 
  dplyr::select(-c(d))

dparcelas <- read.csv("C:/tesis_catie/Calderon_CATIE/data/clean/data_posicion_parcelas.csv", header = T)
dparcelas <- clean_names(dparcelas)

denv <- read.csv("C:/tesis_catie/Calderon_CATIE/data/clean/data_enviroment_worldclim_clean.csv", header = T, row.names = 1)
denv <- denv %>%
  clean_names() %>% 
    dplyr::select(-c(crtm_90_x,crtm_90_y,forest_type, slope_per,slope_deg))

#Standarize data
denvi_est <-  scale(denv,center = F, scale = T )
denvi_est <- rownames_to_column(as.data.frame(denvi_est),var= "plot")
```

#Join Data sets

```{r}
dfull  <- left_join(dredun_eff, dparcelas,by=c("plot") ) %>% 
  left_join(.,denvi_est, by=c("plot") )

#Ordenar columnas
dfull_est <- dfull %>% dplyr::select(plot, forest_type,longitude,latitude,crtm_90_x,crtm_90_y,n,redundancy,u , q, everything()) 
glimpse(dfull_est)
```

#Data exploration
##PCA sin variables de respuesta

```{r}
ncol(denvi_est)
pca_envi <- prcomp(denvi_est[,2:18], scale. = TRUE)
ggbiplot(pca_envi, obs.scale = 3, var.scale = 3,
  groups = dfull_est$forest_type, ellipse = TRUE) +
  scale_color_discrete(name = '') +
  theme(legend.direction = 'horizontal', legend.position = 'top')+
  theme_grey()
```


##Correlaciones Redundancy vrs Environment

```{r fig.width=40, fig.height=40, results='asis', fig.fullwidth=TRUE, fig.dim= 200}
chart.Correlation(dfull_est[,c(8,3,4, 11:27)], histogram=TRUE, pch="+") 
```

##VIFs
```{r}
corvif(dfull_est[,c(3,4,11:27)])
```

##Covariables que se van a eliminar 


+ __tempsd__. Debido a que no tiene relacion con redundancy
+ __mg__. Debido a que no tiene relacion con redundancy
+ __ca__. Debido a que no tiene relacion con redundancy
+ __p__. Debido a que no tiene relacion con redundancy
+ __elev__. Debido a que tiene alto VIF, alta correlacion con Latitude y en el pca tiene la misma direccion que organic matter y sand 
+ __sand__. Debido a que tiene alto VIF  y en el pca tiene la misma direccion que organic matter.
+ __prec__. alta correlacion con predriest y en el pca tiene la misma direccion que prec.
+ __preccv__. Alta correlacion con predriest, en el pca tiene la misma direccion que prec y tiene poca relacion con redundancia.
+ __limo__. Tiene poca relacion con redundancia.
+ __pH__. Tiene poca relacion con redundancia.
+ __k__. Tiene poca relacion con redundancia.
+ __acidity__. Debido a que en el PCA tiene la misma direccion que clay 

####Data que se va a utilizar
```{r}
dredundancy_eff <- dfull_est %>% 
  dplyr::select(-c(tempsd, mg, ca, p, elev, sand, prec, preccv, tempmin, limo, p_h, u,q,k, acidity))
```

###VIFs sin variables eliminadas 
```{r}
ncol(dredundancy_eff)
corvif(dredundancy_eff[,c(3,4,7:12)])
```

##Cleveland plot

```{r}
Mydotplot(dredundancy_eff[, 8:12])
```



#Modelo lineal con componente espacial sin interacciones 

##Model Formulation
$$redundancia \sim N(\mu_i, \sigma^2)$$

$$E(redundancia)=\mu_i ,var(redundancia)=\sigma^2$$ 

$$\mu_i= \beta_1*foresttype+\beta_2*long+\beta_3*lat+\beta_4*clay+\beta_5*acidity$$  $$+\beta_6*k+\beta_7*organicmatter+\beta_8*precdriest+\beta_9*temp + \mu_i $$
$$\mu_i \sim GMRF(0, \Sigma)$$

$\mu_i$ es un random intercep el cual se asume que está correlacionado espacialmente con media 0 y con una matriz de covarianza $\Sigma$ 



##Defining the mesh 

```{r}

dredundancy_eff$crtm_90_x <- dredundancy_eff$crtm_90_x /1000

dredundancy_eff$crtm_90_y <- dredundancy_eff$crtm_90_y/1000

Loc <- cbind(dredundancy_eff$crtm_90_x, dredundancy_eff$crtm_90_y)
head(Loc)
D <- dist(Loc)
hist(D, 
     freq = TRUE,
     main = "",
     ylab = "Frequency")

```

```{r}
plot(x = sort(D), 
     y = (1:length(D))/length(D), 
     type = "l",
     xlab = "",
     ylab = "Cumulative proportion")
text(10, 1, "B", cex = 1.5)
```


```{r}
##requiring necessary packages:
#library(sp)  # vector data
#library(rgeos)  # geometry ops
#library(sp) 
#library(raster)
#
## WGS84 -------------------------------------------------------------------
##Create spatial object:
#lonlat <- cbind(dredundancy_eff$longitude, dredundancy_eff$latitude)
##Create a SpatialPoints object:
#pts <- SpatialPoints(lonlat)
#crdref <- CRS('+proj=longlat +datum=WGS84')
#pts <- SpatialPoints(lonlat, proj4string=crdref)
#
## make spatial data frame
#ptsdf <- SpatialPointsDataFrame(pts,data = dredundancy_eff )
#
#dist <- pointDistance(pts, lonlat=TRUE)
#

# CRTM05 ------------------------------------------------------------------
#lonlat2 <- cbind(dprueba$crtm_90_x, dprueba$crtm_90_y)
##Create a SpatialPoints object:
#pts2 <- SpatialPoints(lonlat2)
#
## make spatial data frame
#ptsdf2 <- SpatialPointsDataFrame(pts2,data = dprueba )
#
#dist2 <- pointDistance(pts2, lonlat=FALSE)
#
#View(dist)
#View(dist2)
```




```{r, fig.width=10, fig.height=12}
#Coordenadas CRTM05
head(Loc)

#mesh1 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(1,1),
#                     cutoff = 0)

mesh2 <- inla.mesh.2d(Loc,
                      #The smaller the values, equal to more triangles 
                      max.edge = c(10,10),
                      cutoff = 0)

#mesh3 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(50,50),
#                      cutoff = 0)

#mesh4 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(75,75),
#                      cutoff = 0)
#mesh5 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(25,50),
#                      cutoff = 0)
#
#mesh6 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(50,80),
#                      cutoff = 0)
#
#mesh7 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(100,120),
#                      cutoff = 0)
#
#mesh8 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(100,100),
#                      cutoff = 0)
#
#mesh9 <- inla.mesh.2d(Loc,
#                      #The smaller the values, equal to more triangles 
#                      max.edge = c(150,150),
#                      cutoff = 0)

#El libro recomienda trabajar con una mesh de entre 700 a 800
mesh2$n

plot(mesh2, asp = 1);points(Loc, col = 2, pch = 16, cex = 1)
```




```{r}

#Specify a boundary area so that all sampling locations are within this boundary area 
bound <- inla.nonconvex.hull(Loc)
mesh10 <- inla.mesh.2d(boundary = bound,
                       max.edge = 2,
                       cutoff = 0)

mesh10$n

plot(mesh10, asp = 1);points(Loc, col = 2, pch = 16, cex = 1)


```




```{r}
A2 <- inla.spde.make.A(mesh2, loc = Loc)
dim(A2)
```

##Define the SPDE

```{r}
spde <- inla.spde2.matern(mesh2, alpha = 2)
```

##Define the spatial field
```{r}
w_index <- inla.spde.make.index(
  name = "w",
  n.spde = spde$n.spde,
  n.group = 1,
  n.repl = 1
)

str(w_index)
```

##Define the stack


###Covariates


```{r}
xm <- model.matrix(~ -1 + forest_type * clay  *
                          organic_matter *precdriest * temp, 
                   
                   data = dredundancy_eff)

N <- nrow(dredundancy_eff)

colnames(xm)

#En esta parte se tienen que incluir interacciones no solo main effects
X <- data.frame(Foothills   =    xm[,1],
                P.macroloba =    xm[,2],
                Q.paraensis =    xm[,3],
                clay        =    xm[,4],
                organic_matter = xm[,5],
                precdriest  =    xm[,6],
                temp        =    xm[,7],
                
                #2way interactions
                P.macroloba_clay = xm[,8],
                Q.paraensis_clay = xm[,9],
                P.macroloba_organic_matter = xm[,10],
                Q.paraensis_organic_matter = xm[,11],
                clay_organic_matter = xm[,12],
                P.macroloba_precdriest = xm[,13],
                Q.paraensis_precdriest = xm[,14],
                clay_precdriest = xm[,15],
                organic_matter_precdriest = xm[,16],
                P.macroloba_temp = xm[,17],
                Q.paraensis_temp = xm[,18],
                clay_temp = xm[,19],
                organic_matter_temp = xm[,20],
                precdriest_temp = xm[,21],
                
                #3way interactions
                P.macroloba_clay_organic_matter = xm[,22],
                Q.paraensis_clay_organic_matter = xm[,23],
                P.macroloba_clay_precdriest = xm[,24],
                Q.paraensis_clay_precdriest = xm[,25],
                P.macroloba_organic_matter_precdriest = xm[,26],
                Q.paraensis_organic_matter_precdriest = xm[,27],
                clay_organic_matter_precdriest = xm[,28],
                P.macroloba_clay_temp = xm[,29],
                Q.paraensis_clay_temp = xm[,30],
                P.macroloba_organic_matter_temp = xm[,31],
                Q.paraensis_organic_matter_temp = xm[,32],
                clay_organic_matter_temp = xm[,33],
                P.macroloba_precdriest_temp = xm[,34],
                Q.paraensis_precdriest_temp = xm[,35],
                clay_precdriest_temp = xm[,36],
                organic_matter_precdriest_temp = xm[,37],
                
                #4way interactions
                P.macroloba_clay_organic_matter_precdriest = xm[,38],
                Q.paraensis_clay_organic_matter_precdriest = xm[,39],
                P.macroloba_clay_organic_matter_temp = xm[,40],
                Q.paraensis_clay_organic_matter_temp = xm[,41],
                P.macroloba_clay_precdriest_temp = xm[,42],
                Q.paraensis_clay_precdriest_temp = xm[,43],
                P.macroloba_organic_matter_precdriest_temp = xm[,44],
                Q.paraensis_organic_matter_precdriest_temp = xm[,45],
                clay_organic_matter_precdriest_temp = xm[,46],
                
                #5way interactions
                P.macroloba_clay_organic_matter_precdriest_temp = xm[,47],
                Q.paraensis_clay_organic_matter_precdriest_temp = xm[,48]
                       
                
)
```

###Stack fit
```{r}
stackfit <- inla.stack(
  tag = "Fit",
  
  data = list(y = dredundancy_eff$redundancy),
  
  A = list(1,1, A2),
  
  effects = list(
    
  Intercept = rep(1,N),
    
  X = X,
    
  w = w_index))
```


##Define the formula for the spatial model


```{r, eval=FALSE}
                Foothills       
                P.macroloba     
                Q.paraensis     
                clay            
                organic_matter 
                precdriest  
                temp        
                
                #2way interactions
                P.macroloba_clay 
                Q.paraensis_clay 
                P.macroloba_organic_matter 
                Q.paraensis_organic_matter 
                clay_organic_matter 
                P.macroloba_precdriest 
                Q.paraensis_precdriest 
                clay_precdriest 
                organic_matter_precdriest 
                P.macroloba_temp 
                Q.paraensis_temp 
                clay_temp 
                organic_matter_temp 
                precdriest_temp 
                
                #3way interactions
                P.macroloba_clay_organic_matter 
                Q.paraensis_clay_organic_matter 
                P.macroloba_clay_precdriest 
                Q.paraensis_clay_precdriest 
                P.macroloba_organic_matter_precdriest
                Q.paraensis_organic_matter_precdriest
                clay_organic_matter_precdriest 
                P.macroloba_clay_temp
                Q.paraensis_clay_temp
                P.macroloba_organic_matter_temp 
                Q.paraensis_organic_matter_temp 
                clay_organic_matter_temp 
                P.macroloba_precdriest_temp
                Q.paraensis_precdriest_temp
                clay_precdriest_temp
                organic_matter_precdriest_temp 
                
                #4way interactions
                P.macroloba_clay_organic_matter_precdriest 
                Q.paraensis_clay_organic_matter_precdriest 
                P.macroloba_clay_organic_matter_temp
                Q.paraensis_clay_organic_matter_temp
                P.macroloba_clay_precdriest_temp
                Q.paraensis_clay_precdriest_temp
                P.macroloba_organic_matter_precdriest_temp 
                Q.paraensis_organic_matter_precdriest_temp 
                clay_organic_matter_precdriest_temp 
                
                #5way interactions
                P.macroloba_clay_organic_matter_precdriest_temp
                Q.paraensis_clay_organic_matter_precdriest_temp
```



```{r}
#Modelo sin dependencia espacial

M2 <- y ~ -1 + Intercept +  Foothills + P.macroloba + Q.paraensis + clay + organic_matter +
                         precdriest + temp
```


```{r}
#Modelo sin covariables y con dependencia espacial 

SM1 <- y ~ -1 + Intercept + f(w, model = spde)

```


```{r}
#Modelo con covariables y dependencia espacial
SM2 <- y ~ -1 + Intercept + Foothills + P.macroloba + Q.paraensis + clay +
                          organic_matter +
                         precdriest + temp + f(w, model = spde)
```

```{r}
#Modelo con dependencia espacial y full interacciones 
SM3 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
  
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                precdriest_temp +
                
                #3way interactions
                P.macroloba_clay_organic_matter +
                Q.paraensis_clay_organic_matter +
                P.macroloba_clay_precdriest +
                Q.paraensis_clay_precdriest +
                P.macroloba_organic_matter_precdriest+
                Q.paraensis_organic_matter_precdriest+
                clay_organic_matter_precdriest +
                P.macroloba_clay_temp+
                Q.paraensis_clay_temp+
                P.macroloba_organic_matter_temp +
                Q.paraensis_organic_matter_temp +
                clay_organic_matter_temp +
                P.macroloba_precdriest_temp+
                Q.paraensis_precdriest_temp+
                clay_precdriest_temp+
                organic_matter_precdriest_temp +
               
                #4way interactions
                P.macroloba_clay_organic_matter_precdriest +
                Q.paraensis_clay_organic_matter_precdriest +
                P.macroloba_clay_organic_matter_temp+
                Q.paraensis_clay_organic_matter_temp+
                P.macroloba_clay_precdriest_temp+
                Q.paraensis_clay_precdriest_temp+
                P.macroloba_organic_matter_precdriest_temp +
                Q.paraensis_organic_matter_precdriest_temp +
                clay_organic_matter_precdriest_temp +
                
                #5way interactions
                P.macroloba_clay_organic_matter_precdriest_temp+
                Q.paraensis_clay_organic_matter_precdriest_temp + 
                f(w, model = spde)
```

```{r}
#Modelo con dependencia espacial  y 2way interacciones 
SM3a <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                precdriest_temp +
   f(w, model = spde)




```

```{r}
#Modelo con dependencia espacial, 2way y 3way interacciones. 
SM3b <- y ~ -1 + Intercept + 
                
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
  
   #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                precdriest_temp +
                
   #3way interactions
                P.macroloba_clay_organic_matter +
                Q.paraensis_clay_organic_matter +
                P.macroloba_clay_precdriest +
                Q.paraensis_clay_precdriest +
                P.macroloba_organic_matter_precdriest+
                Q.paraensis_organic_matter_precdriest+
                clay_organic_matter_precdriest +
                P.macroloba_clay_temp+
                Q.paraensis_clay_temp+
                P.macroloba_organic_matter_temp +
                Q.paraensis_organic_matter_temp +
                clay_organic_matter_temp +
                P.macroloba_precdriest_temp+
                Q.paraensis_precdriest_temp+
                clay_precdriest_temp+
                organic_matter_precdriest_temp +
 
  f(w, model = spde)




```

```{r}
#Modelo con covariables con 2way,3way, 4way interactions y dependencia espacial

SM3c <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
  
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                precdriest_temp +
                
                #3way interactions
                P.macroloba_clay_organic_matter +
                Q.paraensis_clay_organic_matter +
                P.macroloba_clay_precdriest +
                Q.paraensis_clay_precdriest +
                P.macroloba_organic_matter_precdriest+
                Q.paraensis_organic_matter_precdriest+
                clay_organic_matter_precdriest +
                P.macroloba_clay_temp+
                Q.paraensis_clay_temp+
                P.macroloba_organic_matter_temp +
                Q.paraensis_organic_matter_temp +
                clay_organic_matter_temp +
                P.macroloba_precdriest_temp+
                Q.paraensis_precdriest_temp+
                clay_precdriest_temp+
                organic_matter_precdriest_temp +
               
                #4way interactions
                P.macroloba_clay_organic_matter_precdriest +
                Q.paraensis_clay_organic_matter_precdriest +
                P.macroloba_clay_organic_matter_temp+
                Q.paraensis_clay_organic_matter_temp+
                P.macroloba_clay_precdriest_temp+
                Q.paraensis_clay_precdriest_temp+
                P.macroloba_organic_matter_precdriest_temp +
                Q.paraensis_organic_matter_precdriest_temp +
                clay_organic_matter_precdriest_temp +
   f(w, model = spde)
```




##Execute the spacial model
```{r}

#Modelo sin dependencia espacial
M2 <- inla(M2,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))


#Modelo sin covariables y dependencia espacial               

SM1 <- inla(SM1,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))



#Modelo con covariables y dependencia espacial               
SM2 <- inla(SM2,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con covariables con full interacciones y dependencia espacial               
SM3 <- inla(SM3,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con covariables con 2way interactions y dependencia espacial
SM3a <- inla(SM3a,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con covariables con 2way y 3way interactions y dependencia espacial
SM3b <- inla(SM3b,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con covariables con 2way,3way, 4way interactions y dependencia espacial
SM3c <- inla(SM3c,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))


```

##Compare models

```{r}
dic  <- c(M2$dic$dic,
          SM1$dic$dic, 
          SM2$dic$dic,
          SM3$dic$dic,
          SM3a$dic$dic,
          SM3b$dic$dic,
          SM3c$dic$dic)



waic <- c(M2$waic$waic, 
          SM1$waic$waic,
          SM2$waic$waic,
          SM3$waic$waic,
          SM3a$waic$waic,
          SM3b$waic$waic,
          SM3c$waic$waic)


Z.out     <- cbind(dic, waic)
rownames(Z.out) <- c("Gaussian lm ",
                     "Gaussian lm sin covariables sin interaccion + SPDE",
                     "Gaussian lm con covariables sin interaccion + SPDE",
                     "Gaussian lm con covariables con interaccion + SPDE",
                     "Gaussian lm con covariables con 2way interactions + SPDE",
                     "Gaussian lm con covariables con 2way interactions + 3way interactions + SPDE",
                     "Gaussian lm con covariables con 2way interactions + 3way interactions + 4way interactions + SPDE")
Z.out
```


El modelo con todas las covariables y 2way interactions es el mejor (SM3a)

```{r}
#Modelo con dependencia espacial  y 2way interacciones 
SM3a <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                precdriest_temp +

 f(w, model = spde)


#Modelo con dependencia espacial eliminando interacciones que considero no son valiosas 
SM3a_1 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
    
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                
                organic_matter_temp +
                precdriest_temp +

 f(w, model = spde)

#Modelo con dependencia espacial dejando interacciones solo por tipo de bosque 
SM3a_2 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
    
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                
                
                P.macroloba_temp +
                Q.paraensis_temp +
                
                

 f(w, model = spde)

#Modelo con dependencia espacial  eliminando interacciones con clay 
SM3a_3 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                
                
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
               
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                
                organic_matter_temp +
                precdriest_temp +

 f(w, model = spde)

#Modelo con dependencia espacial  eliminando interacciones con bosque 
SM3a_4 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
               
                
                
                
                clay_organic_matter +
                
                
                clay_precdriest +
                organic_matter_precdriest +
                
                
                clay_temp +
                organic_matter_temp +
                precdriest_temp +

 f(w, model = spde)


#Modelo con dependencia espacial  eliminando interacciones con organic matter
SM3a_5 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                
                
                
                P.macroloba_precdriest +
                Q.paraensis_precdriest +
                clay_precdriest +
                organic_matter_precdriest +
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                
                precdriest_temp +

 f(w, model = spde)


#Modelo con dependencia espacial  eliminando interacciones con precdriest
SM3a_6 <- y ~ -1 + Intercept + 
  
                Foothills     +  
                P.macroloba   +  
                Q.paraensis   +  
                clay          +  
                organic_matter + 
                precdriest  +
                temp          +
                
                #2way interactions
                P.macroloba_clay +
                Q.paraensis_clay +
                P.macroloba_organic_matter +
                Q.paraensis_organic_matter +
                clay_organic_matter +
                
                
                
                
                P.macroloba_temp +
                Q.paraensis_temp +
                clay_temp +
                organic_matter_temp +
                

 f(w, model = spde)


```


```{r}
#Modelo con covariables con 2way interactions y dependencia espacial
SM3a <- inla(SM3a,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con dependencia espacial eliminando interacciones que considero no son valiosas
SM3a_1 <- inla(SM3a_1,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))


#Modelo con dependencia espacial dejando interacciones solo por tipo de bosque
SM3a_2 <- inla(SM3a_2,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con dependencia espacial  eliminando interacciones con clay 
SM3a_3 <- inla(SM3a_3,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con dependencia espacial  eliminando interacciones con bosque 
SM3a_4 <- inla(SM3a_4,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con dependencia espacial  eliminando interacciones con organic matter
SM3a_5 <- inla(SM3a_5,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

#Modelo con dependencia espacial  eliminando interacciones con precdriest
SM3a_6 <- inla(SM3a_6,
             family = "gaussian",
             
             data = inla.stack.data(stackfit),
             
             control.compute = list(
               dic = TRUE,
               waic = TRUE),
             
             control.predictor = list(
               A = inla.stack.A(stackfit)))

```


```{r}
dic  <- c(SM3a$dic$dic,
          SM3a_1$dic$dic,
          SM3a_2$dic$dic,
          SM3a_3$dic$dic,
          SM3a_4$dic$dic,
          SM3a_5$dic$dic,
          SM3a_6$dic$dic
          )


waic <- c(SM3a$waic$waic,
          SM3a_1$waic$waic,
          SM3a_2$waic$waic,
          SM3a_3$waic$waic,
          SM3a_4$waic$waic,
          SM3a_5$waic$waic,
          SM3a_6$waic$waic
          )


Z.out     <- cbind(dic, waic)
rownames(Z.out) <- c("SM3a",
                     "SM3a_1",
                     "SM3a_2",
                     "SM3a_3",
                     "SM3a_4",
                     "SM3a_5",
                     "SM3a_6"
                     )
Z.out
```



##Results
```{r}
#Modelo sin componente espacial
M2$summary.fixed[, c("mean", "0.025quant", "0.975quant")]

#Modelo con covariables y componente espacial
SM2$summary.fixed[, c("mean", "0.025quant", "0.975quant")]

#Modelo con interacciones y componente espacial
SM3$summary.fixed[, c("mean", "0.025quant", "0.975quant")]

#Modelo con 2war interacciones y componente espacial
SM3a$summary.fixed[, c("mean", "0.025quant", "0.975quant")]
```

##Hyperpameters
```{r}
spfi_w <- inla.spde2.result(inla = SM2,
                            name = "w",
                            spde = spde,
                            do.transfer = TRUE)


kappa <- inla.emarginal(function(x) x,
                        spfi_w$marginals.kappa[[1]])
                        
sigmau <- inla.emarginal(function(x) sqrt(x),
                         spfi_w$marginals.variance.nominal[[1]])

r <- inla.emarginal(function(x) x, 
                    spfi_w$marginals.range.nominal[[1]])

#Posterior mean kappa
kappa

#Posterior mean sigma_mu
sigmau

#Posterior mean r
r
```

##Matérn correlation values
```{r}
#Show correlation structure
D     <- as.matrix(dist(mesh2$loc[,1:2]))
d.vec <- seq(0, max(D), length = 100)      
Cor.M <- (kappa * d.vec) * besselK(kappa * d.vec, 1) 
Cor.M[1] <- 1

plot(x = d.vec, 
     y = Cor.M, 
     pch = 16, 
     type = "l", 
     cex.lab = 1.5,
     xlab = "Distance (¿km?)", 
     ylab = "Correlation",
     xlim = c(0, 200))
```

##Interpolation
```{r}
w_pm <- SM2$summary.random$w$mean

w_proj <- inla.mesh.projector(mesh2)

w_pm100_100 <- inla.mesh.project(w_proj,w_pm)

```


```{r fig.width= 10, fig.height= 12}
grid <- expand.grid(x = w_proj$x, 
                    y = w_proj$y)

grid$z <- as.vector(w_pm100_100) 

library(grid)   

head(grid)  
levelplot(z ~ x * y,
          data = grid, 
          aspect = "iso",
          scales = list(draw = TRUE),
          xlab = list( cex = 1.5),
          ylab = list( cex = 1.5),
          main = list("Posterior mean spatial random field", cex = 1.5),
          panel=function(...){
            panel.levelplot(...)
            grid.points(x = dredundancy_eff$crtm_90_x, 
                        y = dredundancy_eff$crtm_90_y, 
                        pch = 1,
                        size = unit(0.5, "char"))}  )
```

